- hosts: controller
  become: yes
  gather_facts: false
  tasks:
    - name: Read node-token
      shell: cat /var/lib/rancher/k3s/server/node-token
      register: node_token_output
    - name: Add node_token to facts
      ansible.builtin.set_fact:
        cacheable: true
        node_token: "{{ node_token_output.stdout_lines[0] }}"
- hosts: workers
  become: yes
  gather_facts: false
  environment:
    K3S_URL: "https://{{ hostvars['ccabral']['private_ip'] }}:6443"
    K3S_TOKEN: "{{ hostvars['ccabral']['node_token'] }}"
  roles:
    - k3s
